#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "core/vm.h"

// VM Global Variables
Variable variables[MAX_VARS]; // Stores all variables defined by `keep`
int var_count = 0;			  // Current number of stored variables

/**
 * Sets or updates a variable in the runtime environment
 */
void set_variable(const char *name, const char *value)
{
	for (int i = 0; i < var_count; i++)
	{
		if (strcmp(variables[i].name, name) == 0)
		{
			// Update value if variable already exists
			strncpy(variables[i].value, value, MAX_STRING - 1);
			variables[i].value[MAX_STRING - 1] = '\0';
			return;
		}
	}

	// Create new variable
	strncpy(variables[var_count].name, name, MAX_STRING - 1);
	variables[var_count].name[MAX_STRING - 1] = '\0';

	strncpy(variables[var_count].value, value, MAX_STRING - 1);
	variables[var_count].value[MAX_STRING - 1] = '\0';

	var_count++;
}

/**
 * Retrieves the value of a variable by name
 */
const char *get_variable(const char *name)
{
	for (int i = 0; i < var_count; i++)
	{
		if (strcmp(variables[i].name, name) == 0)
		{
			return variables[i].value;
		}
	}
	return NULL; // Variable not found
}

/**
 * Executes the bytecode generated by the compiler
 */
void execute(Bytecode bc)
{
	for (int i = 0; i < bc.count; i++)
	{
		Instruction inst = bc.instructions[i];

		if (inst.op == OP_KEEP)
		{
			// Variable storage in the environment
			set_variable(inst.name, inst.operand);
			continue;
		}

		if (inst.op == OP_SAY)
		{
			// Prints different types of data
			switch (inst.token_type)
			{
			case TOKEN_STRING:
				printf("%s\n", inst.operand);
				break;

			case TOKEN_NUMBER:
				printf("%g\n", atof(inst.operand)); // Convert string to number
				break;

			case TOKEN_BOOL:
				printf(strcmp(inst.operand, "true") == 0 ? "true\n" : "false\n");
				break;

			case TOKEN_IDENTIFIER:
			{
				const char *val = get_variable(inst.operand);
				if (val)
				{
					printf("%s\n", val);
				}
				else
				{
					printf("Error: variable '%s' is not defined.\n", inst.operand);
				}
				break;
			}

			default:
				printf("Error: unknown value type for say()\n");
			}
		}

		if (inst.op == OP_END)
		{
			break; // Finish the execution
		}
	}
}
